import subprocess
import datetime
import os

def scan_for_vulnerabilities(env_name):
    # Activate the Anaconda environment
    subprocess.run(["conda", "activate", env_name])

    # Run the safety command with the "check" argument to check for vulnerable Python packages
    output = subprocess.run(["safety", "check"], capture_output=True, text=True)
    output = output.stdout

    # Deactivate the Anaconda environment
    subprocess.run(["conda", "deactivate"])

    # Check the output for the presence of the "Vulnerabilities found" message
    if "Vulnerabilities found" in output:
        print("Vulnerabilities detected.")
        return True, output
    else:
        print("No vulnerabilities detected.")
        return False, output

def write_report(vulnerabilities_found, output):
    # Get the current date and time
    now = datetime.datetime.now()
    date_str = now.strftime("%Y-%m-%d")
    time_str = now.strftime("%H:%M:%S")

    # Create the report file name with the date and time
    report_file = f"vulnerability_report_{date_str}_{time_str}.txt"

    # Open the report file in write mode
    with open(report_file, "w") as f:
        # Write the date and time to the file
        f.write(f"Date: {date_str}\nTime: {time_str}\n\n")
        # Write the vulnerabilities found message to the file
        if vulnerabilities_found:
            f.write("Vulnerabilities found:\n\n")
            # Write the output of the safety check command to the file
            f.write(output)
        else:
            f.write("No vulnerabilities found.")

def main():
    env_name = "myenv"  # Replace "myenv" with the name of your Anaconda environment
    vulnerabilities_found, output = scan_for_vulnerabilities(env_name)
    write_report(vulnerabilities_found, output)

if __name__ == "__main__":
    main()
